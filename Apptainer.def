Bootstrap: docker
From: rockylinux:8.8

%labels
    Author YourCompany
    CUDA torch-cu124
    Purpose gpt-oss-20b-lora-sft

%environment
    export LANG=C.UTF-8
    export LC_ALL=C.UTF-8
    export PYTHONUNBUFFERED=1
    export HF_HOME=/workspace/hf
    export TRANSFORMERS_CACHE=/workspace/hf
    export CUDA_VISIBLE_DEVICES=all

%post
    set -e

    echo "=== System packages ==="
    dnf install -y \
        python39 \
        python39-devel \
        git \
        gcc \
        gcc-c++ \
        make \
        wget \
        which \
        numactl-libs \
        && dnf clean all

    ln -sf /usr/bin/python3.9 /usr/bin/python
    ln -sf /usr/bin/pip3.9 /usr/bin/pip

    echo "=== Upgrade pip ==="
    pip install --no-cache-dir --upgrade pip setuptools wheel

    echo "=== Install PyTorch (CUDA 12.4) ==="
    pip install --no-cache-dir \
        torch==2.2.2+cu124 \
        torchvision==0.17.2+cu124 \
        torchaudio==2.2.2+cu124 \
        --index-url https://download.pytorch.org/whl/cu124

    echo "=== Verify torch ==="
    python - << 'EOF'
import torch
print("torch:", torch.__version__)
print("cuda available:", torch.cuda.is_available())
EOF

    echo "=== Install LLM stack ==="
    pip install --no-cache-dir \
        transformers==4.41.2 \
        datasets \
        accelerate \
        peft \
        trl==0.9.6 \
        sentencepiece \
        protobuf \
        einops

    echo "=== bitsandbytes ==="
    pip install --no-cache-dir bitsandbytes==0.43.1

    echo "=== unsloth ==="
    pip install --no-cache-dir unsloth

    echo "=== Sanity import test ==="
    python - << 'EOF'
import torch, transformers, trl, bitsandbytes, unsloth
print("ALL IMPORT OK")
EOF

%runscript
    exec python "$@"
