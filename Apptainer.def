Bootstrap: docker
From: nvidia/cuda:12.4.0-base-rockylinux8

%labels
    Author YourName
    Version 1.0

%files
    # 將主機上的 wheels 資料夾直接複製到容器根目錄下的 /wheels
    /home/vboxuser/host_wheels /wheels

%environment
    export PATH=/opt/venv/bin:$PATH
    export PYTHONNOUSERSITE=1

%post
    # 1. 更新並安裝系統依賴
    dnf -y update && dnf clean all
    dnf install -y python39 python39-pip python39-devel gcc gcc-c++ git && dnf clean all

    # 2. 建立虛擬環境
    python3.9 -m venv /opt/venv
    # 注意：在 %post 中使用虛擬環境，直接使用絕對路徑的 pip 最為穩妥
    
    # 3. 安裝 Wheels
    # 這裡直接指向 %files 階段已經準備好的 /wheels 路徑
    /opt/venv/bin/pip install --no-index --find-links=/wheels \
        torch-2.6.0+cu124-cp39-cp39-linux_x86_64.whl \
        torchvision-0.21.0+cu124-cp39-cp39-linux_x86_64.whl \
        torchaudio-2.6.0+cu124-cp39-cp39-linux_x86_64.whl \
        unsloth-2025.12.9-py3-none-any.whl \
        unsloth_zoo-2025.12.7-py3-none-any.whl \
        trl-0.22.2-py3-none-any.whl \
        accelerate-1.10.1-py3-none-any.whl \
        peft-0.17.1-py3-none-any.whl \
        bitsandbytes-0.48.2-py3-none-any.whl \
        transformers-4.56.2-py3-none-any.whl

    # 選擇性：安裝完後可以刪除容器內的 wheels 以縮小鏡像體積
    # rm -rf /wheels

%runscript
    # 啟動時自動進入虛擬環境並執行指令
    . /opt/venv/bin/activate
    exec "$@"