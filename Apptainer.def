Bootstrap: docker
From: nvidia/cuda:12.4.0-base-rockylinux8

%labels
    Author YourName
    Version 1.0

%post
    dnf -y update && dnf clean all
    dnf install -y python39 python39-pip python39-devel gcc gcc-c++ git && dnf clean all

    mkdir -p /wheels
    cp -r /host_wheels/* /wheels/ || true   # 防止 cp 失敗中斷建置

    # 移除可能造成衝突的 xformers（CPU 環境用不到，且常損壞）
    rm -f /wheels/xformers* /wheels/*xformers* 2>/dev/null || true

    python3.9 -m venv /opt/venv
    . /opt/venv/bin/activate
    pip install --upgrade pip

    # 正確方式 1：直接安裝 wheel 檔案（最推薦，不會有版本衝突）
    pip install --no-index /wheels/torch-2.6.0+cu124-cp39-cp39-linux_x86_64.whl
    pip install --no-index /wheels/torchvision-0.21.0+cu124-cp39-cp39-linux_x86_64.whl
    pip install --no-index /wheels/torchaudio-2.6.0+cu124-cp39-cp39-linux_x86_64.whl
    pip install --no-index /wheels/transformers-4.56.2-py3-none-any.whl
    pip install --no-index /wheels/unsloth-2025.12.9-py3-none-any.whl
    pip install --no-index /wheels/unsloth_zoo-2025.12.7-py3-none-any.whl
    pip install --no-index /wheels/trl-0.22.2-py3-none-any.whl
    pip install --no-index /wheels/accelerate-1.10.1-py3-none-any.whl
    pip install --no-index /wheels/peft-0.17.1-py3-none-any.whl
    pip install --no-index /wheels/bitsandbytes-0.48.2-py3-none-any.whl

%files
    /home/vboxuser/host_wheels /wheels

%environment
    export PATH=/opt/venv/bin:$PATH
    export PYTHONNOUSERSITE=1
